<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snyk Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" nonce="ideNonce">
    <style nonce="ideNonce">
        /* Bootstrap overrides for IDE theme compatibility */
body {
    font-family: var(--vscode-font-family, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif);
    font-size: var(--vscode-font-size, 13px);
    color: var(--vscode-foreground, #cccccc);
    background-color: var(--vscode-editor-background, #1e1e1e);
    padding: 20px;
    margin: 0;
}

/* Override Bootstrap defaults to match IDE theme */
.row {
    margin-left: 0;
    margin-right: 0;
}

.col-md-6 {
    padding-left: 10px;
    padding-right: 10px;
    display: flex;
}

/* Make sections stretch to full height in side-by-side layout */
.col-md-6 > .section {
    flex: 1;
}

h1 {
    font-size: 24px;
    margin-bottom: 20px;
    color: var(--vscode-editor-foreground, #ffffff);
}

h2 {
    font-size: 18px;
    margin-top: 20px;
    margin-bottom: 15px;
    color: var(--vscode-editor-foreground, #ffffff);
    border-bottom: 1px solid var(--vscode-panel-border, #454545);
    padding-bottom: 8px;
}

h3 {
    font-size: 14px;
    margin-top: 15px;
    margin-bottom: 10px;
    color: var(--vscode-editor-foreground, #cccccc);
}

.section {
    margin-bottom: 30px;
    padding: 15px;
    background-color: var(--vscode-editor-inactiveSelectionBackground, #2a2d2e);
    border-radius: 4px;
}

.folder-config {
    margin-bottom: 20px;
    padding: 15px;
    background-color: var(--vscode-editor-background, #252526);
    border: 1px solid var(--vscode-panel-border, #454545);
    border-radius: 4px;
}

.form-group {
    margin-bottom: 15px;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--vscode-input-foreground, #cccccc);
}

.checkbox-label {
    display: flex;
    align-items: center;
    font-weight: normal;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    margin-right: 8px;
}

input[type="text"],
input[type="password"],
input[type="number"],
select,
textarea {
    width: 100%;
    padding: 8px;
    background-color: var(--vscode-input-background, #3c3c3c);
    color: var(--vscode-input-foreground, #cccccc);
    border: 1px solid var(--vscode-input-border, #454545);
    border-radius: 2px;
    box-sizing: border-box;
    font-family: inherit;
    font-size: inherit;
}

input[readonly] {
    background-color: var(--vscode-input-background, #2d2d2d);
    color: var(--vscode-disabledForeground, #808080);
    cursor: not-allowed;
}

textarea {
    resize: vertical;
    font-family: var(--vscode-editor-font-family, 'Monaco', 'Courier New', monospace);
    font-size: 12px;
}

input:focus,
select:focus,
textarea:focus {
    outline: 1px solid var(--vscode-focusBorder, #007acc);
    outline-offset: -1px;
}

.description {
    display: block;
    font-size: 11px;
    color: var(--vscode-descriptionForeground, #969696);
    margin-top: 4px;
    font-style: italic;
}

.error-message {
    color: var(--vscode-errorForeground, #f48771);
    font-size: 12px;
    margin-top: 5px;
    display: block;
}

.hidden {
    display: none !important;
}

.actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--vscode-panel-border, #454545);
}

button {
    padding: 10px 20px;
    background-color: var(--vscode-button-background, #0e639c);
    color: var(--vscode-button-foreground, #ffffff);
    border: none;
    border-radius: 2px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
}

button:hover {
    background-color: var(--vscode-button-hoverBackground, #1177bb);
}

button:active {
    background-color: var(--vscode-button-background, #0e639c);
}

button.secondary {
    background-color: var(--vscode-button-secondaryBackground, #3a3d41);
    color: var(--vscode-button-secondaryForeground, #ffffff);
}

button.secondary:hover {
    background-color: var(--vscode-button-secondaryHoverBackground, #45494e);
}

/* Scan Configuration Styles */
.scan-config-title {
    margin-top: 15px;
    margin-bottom: 10px;
    font-size: 14px;
}

.scan-config-product {
    margin-left: 10px;
}

.scan-config-input {
    margin-top: 5px;
    margin-bottom: 5px;
}

.scan-config-checkbox {
    margin-bottom: 10px;
}

/* Button Group for Authentication Section */
.button-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.button-group input {
    flex: 1;
}

.button-group button {
    flex-shrink: 0;
}

/* Collapsible folder styles */
.folder-toggle {
    color: var(--vscode-editor-foreground, #ffffff);
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    border: none;
    border-bottom: 1px solid var(--vscode-panel-border, #454545);
    padding: 10px 0 !important;
    margin-bottom: 0;
    background-color: transparent;
}

.folder-toggle:hover {
    color: var(--vscode-editor-foreground, #ffffff);
    text-decoration: none;
    background-color: var(--vscode-list-hoverBackground, rgba(255, 255, 255, 0.05));
}

.folder-toggle:focus {
    box-shadow: none;
    outline: 1px solid var(--vscode-focusBorder, #007acc);
}

.collapse-icon {
    transition: transform 0.2s ease;
    font-size: 12px;
}

.folder-toggle[aria-expanded="true"] .collapse-icon {
    transform: rotate(180deg);
}

.collapse {
    transition: height 0.35s ease;
}

.folder-content {
    padding-top: 15px;
}

/* Tooltip badge styling */
.badge.bg-secondary[data-bs-toggle="tooltip"] {
    margin-left: 8px;
    vertical-align: middle;
    cursor: help;
    font-size: 11px;
    padding: 2px 6px;
}

    </style>
</head>
<body>
    <h1>Snyk Configuration</h1>
    <form id="configForm">

        
        <div class="row">
            <div class="col-md-6">
                
                <div class="section">
                    <h2>Scan Configuration</h2>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="activateSnykOpenSource" checked>
                            Activate Snyk Open Source
                            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Find and fix open source dependency issues">?</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="activateSnykCode" checked>
                            Activate Snyk Code
                            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Find and fix security issues in your application code in real time. Note: Snyk Code must be enabled for your organization in Snyk settings">?</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="activateSnykIac" checked>
                            Activate Snyk IaC
                            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Find and fix your IaC misconfigurations">?</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="scanningMode">Scanning Mode <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Choose whether to run Snyk Code scans in the background (auto), or only when you run the Rescan command (manual)">?</span></label>
                        <select id="scanningMode" name="scanningMode">
                            <option value="auto" selected>Auto</option>
                            <option value="manual" >Manual</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="organization">Organization <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specify the organization (ID or name) for Snyk to run scans against. If the organization is provided manually, automatic organization selection is overridden">?</span></label>
                        <input type="text" id="organization" name="organization" value="" placeholder="Organization UUID or Slug">
                    </div>

                    <div class="form-group">
                        <label for="additionalParams">Additional CLI Parameters (Legacy) <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Parameters to pass to Snyk CLI for Open Source security tests. Use folder-specific additional parameters instead">?</span></label>
                        <input type="text" id="additionalParams" name="additionalParams" value="--severity-threshold=high" placeholder="--debug --severity-threshold=high">
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                
                <div class="section">
                    <h2>Filter and Display Settings</h2>

                    <div class="form-group">
                        <label>Filter Severity <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Select which severity levels to display in the results">?</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_critical" checked>
                                Critical
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_high" >
                                High
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_medium" checked>
                                Medium
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_low" >
                                Low
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Issue View Options <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Code Consistent Ignores helps your teams focus on important tasks by filtering out distractions. It ensures that once an ignore is created, it is consistently respected regardless of how and where the test is run">?</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="issueViewOptions_openIssues" checked>
                                Show Open Issues
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="issueViewOptions_ignoredIssues" >
                                Show Ignored Issues
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="enableDeltaFindings">Delta Findings <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specifies whether to see all issues or only net new issues. Net new issues option requires a Git repository, where it compares findings with those in the base branch">?</span></label>
                        <select id="enableDeltaFindings" name="enableDeltaFindings">
                            <option value="false" selected>All Issues</option>
                            <option value="true" >Net New Issues</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="section">
            <h2>Authentication</h2>

            <div class="form-group">
                <label for="authenticationMethod">Authentication Method <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specifies whether to authenticate with OAuth2, PAT, or with an API token (Legacy). Note: OAuth2 authentication is recommended as it provides enhanced security">?</span></label>
                <select id="authenticationMethod" name="authenticationMethod">
                    <option value="token" selected>Token</option>
                    <option value="oauth" >OAuth</option>
                </select>
            </div>

            <div class="form-group">
                <label for="endpoint">Endpoint <span class="badge bg-secondary" data-bs-toggle="tooltip" title="If you're using SSO with Snyk and OAuth2, this is automatically populated. For public regional instances, see Snyk documentation. For private instances, contact your team or account manager">?</span></label>
                <input type="text" id="endpoint" name="endpoint" value="https://api.snyk.io" placeholder="https://app.snyk.io/api">
                <span id="endpoint-error" class="error-message hidden">Invalid Endpoint URL. Expected format: https://api.snyk.io or https://api.*.snykgov.io</span>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="insecure" >
                    Insecure (Skip SSL Verification)
                </label>
            </div>

            <div class="form-group">
                <label for="token">Token</label>
                <div class="button-group">
                    <input type="password" id="token" name="token" value="test-token-12345" placeholder="Snyk API Token">
                    <button type="button" id="authenticate-btn">Authenticate</button>
                    <button type="button" id="logout-btn" class="secondary">Logout</button>
                </div>
            </div>
        </div>

        
        <div class="section">
            <h2>Solution Settings</h2>
            
            
            <div class="folder-config">
                <button class="btn btn-link folder-toggle text-start w-100 d-flex justify-content-between align-items-center p-0" type="button" data-bs-toggle="collapse" data-bs-target="#folder-0" aria-expanded="false" aria-controls="folder-0">
                    <span>/Users/username/workspace/my-project</span>
                    <span class="collapse-icon">▼</span>
                </button>
                <input type="hidden" name="folder_0_folderPath" value="/Users/username/workspace/my-project">
                <div class="collapse folder-content" id="folder-0">

                <div class="form-group">
                    <label for="folder_0_riskScoreThreshold">Risk Score Threshold (0-1000)</label>
                    <input type="number" id="folder_0_riskScoreThreshold" name="folder_0_riskScoreThreshold" min="0" max="1000" value="500" placeholder="0">
                    <span class="description">Minimum risk score to display issues (0 = show all)</span>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="folder_0_autoOrg" data-index="0" onclick="window.toggleOrgField('0')" >
                        Auto Select Organization
                        <span class="badge bg-secondary" data-bs-toggle="tooltip" title="When enabled, Snyk will automatically select the most appropriate organization for your project using context found in your repository. If disabled, you can manually specify the organization">?</span>
                    </label>
                    <input type="hidden" name="folder_0_orgSetByUser" id="folder_0_orgSetByUser" value="true">
                </div>

                <div class="form-group">
                    <label for="folder_0_preferredOrg">Organization <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specify the organization (ID or name) for this folder. If auto-select is enabled, this will show the automatically determined organization (read-only)">?</span></label>
                    <input type="text" id="folder_0_preferredOrg" name="folder_0_preferredOrg" value="my-org-uuid-12345" data-preferred-org="my-org-uuid-12345" data-auto-org="auto-org-uuid-67890" placeholder="Organization UUID or Slug" >
                    <input type="hidden" name="folder_0_autoDeterminedOrg" value="auto-org-uuid-67890">
                </div>

                <div class="form-group">
                    <label for="folder_0_additionalParameters">Additional CLI Parameters <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Parameters to pass to Snyk CLI for this folder's scans. Space-separated arguments (e.g., --severity-threshold=high --debug)">?</span></label>
                    <input type="text" id="folder_0_additionalParameters" name="folder_0_additionalParameters" value="--all-projects --detection-depth=3 " placeholder="--severity-threshold=high">
                </div>
                </div>
            </div>
            
            <div class="folder-config">
                <button class="btn btn-link folder-toggle text-start w-100 d-flex justify-content-between align-items-center p-0" type="button" data-bs-toggle="collapse" data-bs-target="#folder-1" aria-expanded="false" aria-controls="folder-1">
                    <span>/Users/username/workspace/your-project</span>
                    <span class="collapse-icon">▼</span>
                </button>
                <input type="hidden" name="folder_1_folderPath" value="/Users/username/workspace/your-project">
                <div class="collapse folder-content" id="folder-1">

                <div class="form-group">
                    <label for="folder_1_riskScoreThreshold">Risk Score Threshold (0-1000)</label>
                    <input type="number" id="folder_1_riskScoreThreshold" name="folder_1_riskScoreThreshold" min="0" max="1000" value="800" placeholder="0">
                    <span class="description">Minimum risk score to display issues (0 = show all)</span>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="folder_1_autoOrg" data-index="1" onclick="window.toggleOrgField('1')" checked>
                        Auto Select Organization
                        <span class="badge bg-secondary" data-bs-toggle="tooltip" title="When enabled, Snyk will automatically select the most appropriate organization for your project using context found in your repository. If disabled, you can manually specify the organization">?</span>
                    </label>
                    <input type="hidden" name="folder_1_orgSetByUser" id="folder_1_orgSetByUser" value="false">
                </div>

                <div class="form-group">
                    <label for="folder_1_preferredOrg">Organization <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specify the organization (ID or name) for this folder. If auto-select is enabled, this will show the automatically determined organization (read-only)">?</span></label>
                    <input type="text" id="folder_1_preferredOrg" name="folder_1_preferredOrg" value="auto-determined-uuid-99999" data-preferred-org="manual-org-uuid-11111" data-auto-org="auto-determined-uuid-99999" placeholder="Organization UUID or Slug" readonly>
                    <input type="hidden" name="folder_1_autoDeterminedOrg" value="auto-determined-uuid-99999">
                </div>

                <div class="form-group">
                    <label for="folder_1_additionalParameters">Additional CLI Parameters <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Parameters to pass to Snyk CLI for this folder's scans. Space-separated arguments (e.g., --severity-threshold=high --debug)">?</span></label>
                    <input type="text" id="folder_1_additionalParameters" name="folder_1_additionalParameters" value="" placeholder="--severity-threshold=high">
                </div>
                </div>
            </div>
            
            
        </div>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" nonce="ideNonce"></script>
    <script nonce="ideNonce">
        (function() {
    // IE7 Compatible Script

    // Helper to get element by ID
    function get(id) {
        return document.getElementById(id);
    }

    // Helper to get elements by name
    function getByName(name) {
        return document.getElementsByName(name);
    }

    // Helper to add event listener (IE7 compatible)
    function addEvent(element, event, handler) {
        if (element.addEventListener) {
            element.addEventListener(event, handler, false);
        } else if (element.attachEvent) {
            element.attachEvent('on' + event, handler);
        } else {
            element['on' + event] = handler;
        }
    }

    // Helper to remove class (IE7 compatible)
    function removeClass(element, className) {
        if (!element) return;
        var reg = new RegExp('(\\s|^)' + className + '(\\s|$)');
        element.className = element.className.replace(reg, ' ');
    }

    // Helper to add class (IE7 compatible)
    function addClass(element, className) {
        if (!element) return;
        if (element.className.indexOf(className) === -1) {
            element.className += ' ' + className;
        }
    }

    // Validate Endpoint
    function validateEndpoint(url) {
        if (!url) return true; // Empty URL allows default
        // Regex for api.*.snyk.io or api.*.snykgov.io
        var snykRegex = /^https:\/\/api\..*\.snyk\.io/;
        var snykgovRegex = /^https:\/\/api\..*\.snykgov\.io/;
        
        return snykRegex.test(url) || snykgovRegex.test(url) || url === "https://api.snyk.io";
    }

    // Collect form data
    function collectData() {
        var data = {
            folderConfigs: []
        };

        var form = get('configForm');
        var inputs = form.getElementsByTagName('input');
        var selects = form.getElementsByTagName('select');
        var textareas = form.getElementsByTagName('textarea');
        
        // Process all elements
        processElements(inputs, data);
        processElements(selects, data);
        processElements(textareas, data);

        // Process complex objects
        processFilterSeverity(data);
        processIssueViewOptions(data);
        processTrustedFolders(data);

        return data;
    }

    function processElements(elements, data) {
        for (var i = 0; i < elements.length; i++) {
            var el = elements[i];
            var name = el.name;

            if (!name) continue;

            // Skip complex object fields (handled separately)
            if (name.indexOf('filterSeverity_') === 0 || 
                name.indexOf('issueViewOptions_') === 0) {
                continue;
            }

            // Folder logic: folder_INDEX_FIELD or folder_INDEX_scanConfig_PRODUCT_FIELD
            if (name.indexOf('folder_') === 0) {
                var parts = name.split('_');
                if (parts.length >= 3) {
                    var index = parseInt(parts[1]);
                    
                    if (!data.folderConfigs[index]) {
                        data.folderConfigs[index] = {};
                    }

                    // Check if this is a scanConfig field: folder_INDEX_scanConfig_PRODUCT_FIELD
                    if (parts.length >= 5 && parts[2] === 'scanConfig') {
                        var product = parts[3]; // oss, code, or iac
                        var field = parts[4]; // preScanCommand, preScanOnlyReferenceFolder, etc.
                        
                        if (!data.folderConfigs[index].scanCommandConfig) {
                            data.folderConfigs[index].scanCommandConfig = {};
                        }
                        if (!data.folderConfigs[index].scanCommandConfig[product]) {
                            data.folderConfigs[index].scanCommandConfig[product] = {};
                        }
                        
                        // Map UI field names to JSON field names
                        var jsonField = field;
                        if (field === 'preScanCommand') {
                            jsonField = 'command'; // PreScanCommand uses 'command' in JSON
                        }
                        
                        if (el.type === 'checkbox') {
                            data.folderConfigs[index].scanCommandConfig[product][jsonField] = el.checked;
                        } else if (el.value && el.value.trim()) {
                            data.folderConfigs[index].scanCommandConfig[product][jsonField] = el.value;
                        }
                    } else {
                        var field = parts.slice(2).join('_');
                        setFieldValue(data.folderConfigs[index], field, el);
                    }
                }
            } else {
                // Global setting
                setFieldValue(data, name, el);
            }
        }
    }

    function setFieldValue(obj, field, el) {
        if (el.type === 'checkbox') {
            obj[field] = el.checked;
        } else if (el.type === 'number') {
            obj[field] = el.value ? parseInt(el.value) : null;
        } else if (el.tagName.toLowerCase() === 'textarea') {
            // Try to parse as JSON, fallback to string
            try {
                if (el.value && el.value.trim()) {
                    obj[field] = JSON.parse(el.value);
                } else {
                    obj[field] = null;
                }
            } catch (e) {
                obj[field] = el.value;
            }
        } else {
            obj[field] = el.value;
        }
    }

    function processFilterSeverity(data) {
        var critical = getByName('filterSeverity_critical')[0];
        var high = getByName('filterSeverity_high')[0];
        var medium = getByName('filterSeverity_medium')[0];
        var low = getByName('filterSeverity_low')[0];

        if (critical || high || medium || low) {
            data.filterSeverity = {
                critical: critical ? critical.checked : false,
                high: high ? high.checked : false,
                medium: medium ? medium.checked : false,
                low: low ? low.checked : false
            };
        }
    }

    function processIssueViewOptions(data) {
        var openIssues = getByName('issueViewOptions_openIssues')[0];
        var ignoredIssues = getByName('issueViewOptions_ignoredIssues')[0];

        if (openIssues || ignoredIssues) {
            data.issueViewOptions = {
                openIssues: openIssues ? openIssues.checked : false,
                ignoredIssues: ignoredIssues ? ignoredIssues.checked : false
            };
        }
    }

    function processTrustedFolders(data) {
        var trustedFoldersEl = get('trustedFolders');
        if (trustedFoldersEl && trustedFoldersEl.value) {
            var value = trustedFoldersEl.value;
            // Split by comma and filter out empty strings
            var folders = [];
            var parts = value.split(',');
            for (var i = 0; i < parts.length; i++) {
                var folder = parts[i].replace(/^\s+|\s+$/g, ''); // trim
                if (folder) {
                    folders.push(folder);
                }
            }
            data.trustedFolders = folders;
        }
    }

    var originalEndpoint = "";

    // Toggle organization field based on auto-org checkbox
    function toggleOrgField(folderIndex) {
        var autoOrgCheckbox = get('folder_' + folderIndex + '_autoOrg');
        var orgInput = get('folder_' + folderIndex + '_preferredOrg');
        var orgSetByUserInput = get('folder_' + folderIndex + '_orgSetByUser');

        if (!autoOrgCheckbox || !orgInput || !orgSetByUserInput) {
            return;
        }

        var isAutoOrg = autoOrgCheckbox.checked;
        var preferredOrg = orgInput.getAttribute('data-preferred-org') || '';
        var autoOrg = orgInput.getAttribute('data-auto-org') || '';

        if (isAutoOrg) {
            // Auto select is ON: show AutoDeterminedOrg (readonly)
            orgInput.value = autoOrg;
            orgInput.setAttribute('readonly', 'readonly');
            orgSetByUserInput.value = 'false';
        } else {
            // Auto select is OFF: show PreferredOrg (editable)
            orgInput.value = preferredOrg;
            orgInput.removeAttribute('readonly');
            orgSetByUserInput.value = 'true';
        }
    }

    // Expose toggleOrgField to window for inline onclick handlers
    window.toggleOrgField = toggleOrgField;

    // Initialize all folder org fields on page load
    function initializeFolderOrgFields() {
        var allInputs = document.getElementsByTagName('input');
        for (var i = 0; i < allInputs.length; i++) {
            var input = allInputs[i];
            var inputId = input.id || '';
            if (input.type === 'checkbox' && inputId.indexOf('_autoOrg') !== -1 && input.getAttribute('data-index') !== null) {
                var folderIndex = input.getAttribute('data-index');
                toggleOrgField(folderIndex);
            }
        }
    }

    var saveTimeout = null;
    var SAVE_DELAY = 500; // milliseconds delay for debouncing

    // Save handler
    function saveConfig() {
        var endpointInput = get('endpoint');
        var endpointError = get('endpoint-error');
        var currentEndpoint = endpointInput.value;

        if (currentEndpoint && !validateEndpoint(currentEndpoint)) {
            removeClass(endpointError, 'hidden');
            return;
        } else {
            addClass(endpointError, 'hidden');
        }

        var data = collectData();
        var jsonString = JSON.stringify(data);

        // Call IDE injected function
        try {
            window.__ideSaveConfig__(jsonString);

            // If endpoint changed, trigger logout
            if (originalEndpoint && currentEndpoint !== originalEndpoint) {
                 // We might need to wait for save to complete, but here we just trigger it.
                 // Ideally the IDE extension handles the logout if it detects the change,
                 // but the requirement says "logout command should be called".
                 // Since we are in the webview, we can't call the command directly unless we have a binding.
                 // We can use another injected function or rely on the save handler in the extension to check.
                 // Requirement: "when the endpoint (snyk api url) is changed, logout command should be called"
                 // I'll assume we can call a function.
                 if (typeof window.__ideLogout__ !== 'undefined') {
                     window.__ideLogout__();
                 }
            }
        } catch (e) {
            alert('Error saving configuration: ' + e.message);
        }
    }

    // Debounced save - delays save until user stops changing inputs
    function debouncedSave() {
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }
        saveTimeout = setTimeout(function() {
            saveConfig();
        }, SAVE_DELAY);
    }

    // Attach auto-save listeners to all form inputs
    function attachAutoSaveListeners() {
        var form = get('configForm');
        if (!form) return;

        var inputs = form.getElementsByTagName('input');
        var selects = form.getElementsByTagName('select');
        var textareas = form.getElementsByTagName('textarea');

        // Add blur event listeners to all inputs
        for (var i = 0; i < inputs.length; i++) {
            addEvent(inputs[i], 'blur', debouncedSave);
            // Also save on change for checkboxes and radios
            if (inputs[i].type === 'checkbox' || inputs[i].type === 'radio') {
                addEvent(inputs[i], 'change', debouncedSave);
            }
        }

        for (var j = 0; j < selects.length; j++) {
            addEvent(selects[j], 'change', debouncedSave);
        }

        for (var k = 0; k < textareas.length; k++) {
            addEvent(textareas[k], 'blur', debouncedSave);
        }
    }

    function authenticate() {
        // First save
        saveConfig();

        // Then trigger login
        try {
            window.__ideLogin__();
        } catch (e) {
            alert('Error initiating authentication: ' + e.message);
        }
    }

    function logout() {
        // Trigger logout
        try {
            window.__ideLogout__();
        } catch (e) {
            alert('Error initiating logout: ' + e.message);
        }
    }

    // Initialize
    addEvent(window, 'load', function() {
        var authBtn = get('authenticate-btn');
        if (authBtn) {
            addEvent(authBtn, 'click', authenticate);
        }

        var logoutBtn = get('logout-btn');
        if (logoutBtn) {
            addEvent(logoutBtn, 'click', logout);
        }

        var endpointInput = get('endpoint');
        if (endpointInput) {
            originalEndpoint = endpointInput.value;
        }

        // Initialize folder organization field toggles
        initializeFolderOrgFields();

        // Attach auto-save listeners to all form inputs
        attachAutoSaveListeners();

        // Initialize Bootstrap tooltips
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            var tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            for (var i = 0; i < tooltipTriggerList.length; i++) {
                new bootstrap.Tooltip(tooltipTriggerList[i]);
            }
        }
    });

})();

    </script>
</body>
</html>

