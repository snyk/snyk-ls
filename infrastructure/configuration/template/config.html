<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snyk Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" nonce="{{.Nonce}}">
    <style nonce="{{.Nonce}}">
        {{.Styles}}
    </style>
</head>
<body>
    <h1>Snyk Configuration</h1>
    <form id="configForm">

        <!-- Top Row: Scan Configuration and Filter Settings side by side -->
        <div class="row">
            <div class="col-md-6">
                <!-- Scan Configuration -->
                <div class="section">
                    <h2>Scan Configuration</h2>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="activateSnykOpenSource" {{if eq .Settings.ActivateSnykOpenSource "true"}}checked{{end}}>
                            Activate Snyk Open Source
                            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Find and fix open source dependency issues">?</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="activateSnykCode" {{if eq .Settings.ActivateSnykCode "true"}}checked{{end}}>
                            Activate Snyk Code
                            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Find and fix security issues in your application code in real time. Note: Snyk Code must be enabled for your organization in Snyk settings">?</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="activateSnykIac" {{if eq .Settings.ActivateSnykIac "true"}}checked{{end}}>
                            Activate Snyk IaC
                            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Find and fix your IaC misconfigurations">?</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="scanningMode">Scanning Mode <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Choose whether to run Snyk Code scans in the background (auto), or only when you run the Rescan command (manual)">?</span></label>
                        <select id="scanningMode" name="scanningMode">
                            <option value="auto" {{if eq .Settings.ScanningMode "auto"}}selected{{end}}>Auto</option>
                            <option value="manual" {{if eq .Settings.ScanningMode "manual"}}selected{{end}}>Manual</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="organization">Organization <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specify the organization (ID or name) for Snyk to run scans against. If the organization is provided manually, automatic organization selection is overridden">?</span></label>
                        <input type="text" id="organization" name="organization" value="{{.Settings.Organization}}" placeholder="Organization UUID or Slug">
                    </div>

                    <div class="form-group">
                        <label for="additionalParams">Additional CLI Parameters (Legacy) <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Parameters to pass to Snyk CLI for Open Source security tests. Use folder-specific additional parameters instead">?</span></label>
                        <input type="text" id="additionalParams" name="additionalParams" value="{{.Settings.AdditionalParams}}" placeholder="--debug --severity-threshold=high">
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Filter and Display Settings -->
                <div class="section">
                    <h2>Filter and Display Settings</h2>

                    <div class="form-group">
                        <label>Filter Severity <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Select which severity levels to display in the results">?</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_critical" {{if .Settings.FilterSeverity}}{{if .Settings.FilterSeverity.Critical}}checked{{end}}{{end}}>
                                Critical
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_high" {{if .Settings.FilterSeverity}}{{if .Settings.FilterSeverity.High}}checked{{end}}{{end}}>
                                High
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_medium" {{if .Settings.FilterSeverity}}{{if .Settings.FilterSeverity.Medium}}checked{{end}}{{end}}>
                                Medium
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="filterSeverity_low" {{if .Settings.FilterSeverity}}{{if .Settings.FilterSeverity.Low}}checked{{end}}{{end}}>
                                Low
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Issue View Options <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Code Consistent Ignores helps your teams focus on important tasks by filtering out distractions. It ensures that once an ignore is created, it is consistently respected regardless of how and where the test is run">?</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="issueViewOptions_openIssues" {{if .Settings.IssueViewOptions}}{{if .Settings.IssueViewOptions.OpenIssues}}checked{{end}}{{end}}>
                                Show Open Issues
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="issueViewOptions_ignoredIssues" {{if .Settings.IssueViewOptions}}{{if .Settings.IssueViewOptions.IgnoredIssues}}checked{{end}}{{end}}>
                                Show Ignored Issues
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="enableDeltaFindings">Delta Findings <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specifies whether to see all issues or only net new issues. Net new issues option requires a Git repository, where it compares findings with those in the base branch">?</span></label>
                        <select id="enableDeltaFindings" name="enableDeltaFindings">
                            <option value="false" {{if ne .Settings.EnableDeltaFindings "true"}}selected{{end}}>All Issues</option>
                            <option value="true" {{if eq .Settings.EnableDeltaFindings "true"}}selected{{end}}>Net New Issues</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Authentication Settings (below the two-column layout) -->
        <div class="section">
            <h2>Authentication</h2>

            <div class="form-group">
                <label for="authenticationMethod">Authentication Method <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specifies whether to authenticate with OAuth2, PAT, or with an API token (Legacy). Note: OAuth2 authentication is recommended as it provides enhanced security">?</span></label>
                <select id="authenticationMethod" name="authenticationMethod">
                    <option value="token" {{if eq .Settings.AuthenticationMethod "token"}}selected{{end}}>Token</option>
                    <option value="oauth" {{if eq .Settings.AuthenticationMethod "oauth"}}selected{{end}}>OAuth</option>
                </select>
            </div>

            <div class="form-group">
                <label for="endpoint">Endpoint <span class="badge bg-secondary" data-bs-toggle="tooltip" title="If you're using SSO with Snyk and OAuth2, this is automatically populated. For public regional instances, see Snyk documentation. For private instances, contact your team or account manager">?</span></label>
                <input type="text" id="endpoint" name="endpoint" value="{{.Settings.Endpoint}}" placeholder="https://app.snyk.io/api">
                <span id="endpoint-error" class="error-message hidden">Invalid Endpoint URL. Expected format: https://api.snyk.io or https://api.*.snykgov.io</span>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="insecure" {{if eq .Settings.Insecure "true"}}checked{{end}}>
                    Insecure (Skip SSL Verification)
                </label>
            </div>

            <div class="form-group">
                <label for="token">Token</label>
                <div class="button-group">
                    <input type="password" id="token" name="token" value="{{.Settings.Token}}" placeholder="Snyk API Token">
                    <button type="button" id="authenticate-btn">Authenticate</button>
                    <button type="button" id="logout-btn" class="secondary">Logout</button>
                </div>
            </div>
        </div>

        <!-- Folder Specific Settings -->
        <div class="section">
            <h2>{{.FolderLabel}} Settings</h2>
            {{if .Settings.FolderConfigs}}
            {{range $index, $folder := .Settings.FolderConfigs}}
            <div class="folder-config">
                <button class="btn btn-link folder-toggle text-start w-100 d-flex justify-content-between align-items-center p-0" type="button" data-bs-toggle="collapse" data-bs-target="#folder-{{$index}}" aria-expanded="false" aria-controls="folder-{{$index}}">
                    <span>{{$folder.FolderPath}}</span>
                    <span class="collapse-icon">â–¼</span>
                </button>
                <input type="hidden" name="folder_{{$index}}_folderPath" value="{{$folder.FolderPath}}">
                <div class="collapse folder-content" id="folder-{{$index}}">

                <div class="form-group">
                    <label for="folder_{{$index}}_riskScoreThreshold">Risk Score Threshold (0-1000)</label>
                    <input type="number" id="folder_{{$index}}_riskScoreThreshold" name="folder_{{$index}}_riskScoreThreshold" min="0" max="1000" value="{{if $folder.RiskScoreThreshold}}{{$folder.RiskScoreThreshold}}{{end}}" placeholder="0">
                    <span class="description">Minimum risk score to display issues (0 = show all)</span>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="folder_{{$index}}_autoOrg" data-index="{{$index}}" onclick="window.toggleOrgField('{{$index}}')" {{if not $folder.OrgSetByUser}}checked{{end}}>
                        Auto Select Organization
                        <span class="badge bg-secondary" data-bs-toggle="tooltip" title="When enabled, Snyk will automatically select the most appropriate organization for your project using context found in your repository. If disabled, you can manually specify the organization">?</span>
                    </label>
                    <input type="hidden" name="folder_{{$index}}_orgSetByUser" id="folder_{{$index}}_orgSetByUser" value="{{if $folder.OrgSetByUser}}true{{else}}false{{end}}">
                </div>

                <div class="form-group">
                    <label for="folder_{{$index}}_preferredOrg">Organization <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Specify the organization (ID or name) for this folder. If auto-select is enabled, this will show the automatically determined organization (read-only)">?</span></label>
                    <input type="text" id="folder_{{$index}}_preferredOrg" name="folder_{{$index}}_preferredOrg" value="{{if $folder.OrgSetByUser}}{{$folder.PreferredOrg}}{{else}}{{$folder.AutoDeterminedOrg}}{{end}}" data-preferred-org="{{$folder.PreferredOrg}}" data-auto-org="{{$folder.AutoDeterminedOrg}}" placeholder="Organization UUID or Slug" {{if not $folder.OrgSetByUser}}readonly{{end}}>
                    <input type="hidden" name="folder_{{$index}}_autoDeterminedOrg" value="{{$folder.AutoDeterminedOrg}}">
                </div>

                <div class="form-group">
                    <label for="folder_{{$index}}_additionalParameters">Additional CLI Parameters <span class="badge bg-secondary" data-bs-toggle="tooltip" title="Parameters to pass to Snyk CLI for this folder's scans. Space-separated arguments (e.g., --severity-threshold=high --debug)">?</span></label>
                    <input type="text" id="folder_{{$index}}_additionalParameters" name="folder_{{$index}}_additionalParameters" value="{{range $p := $folder.AdditionalParameters}}{{$p}} {{end}}" placeholder="--severity-threshold=high">
                </div>
                </div>
            </div>
            {{end}}
            {{else}}
            <p>No {{.FolderLabel | toLower}}s configured. Open a workspace to configure {{.FolderLabel | toLower}}-specific settings.</p>
            {{end}}
        </div>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" nonce="{{.Nonce}}"></script>
    <script nonce="{{.Nonce}}">
        {{.Scripts}}
    </script>
</body>
</html>
